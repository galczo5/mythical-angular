<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script>
<link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>It looks that TestBed works with esbuild | Mythical Angular</title><link rel=canonical href=https://mythical-angular.dev/posts/ngc-esbuild-jest/><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="It looks that TestBed works with esbuild"><meta property="og:description" content="In previous post &ldquo;esbuild against TestBed&rdquo; I said that TestBed is not working when we use esbuild to bundle tests. It seems like it&rsquo;s possible to work around the problems.
I said also that I&rsquo;m not sure what to think about the TestBed, is it worth using it or not. Every day, I&rsquo;m closer to getting my own opinion. But this is a subject for the next post.
Today we will focus on how to compile our tests with esbuild and still be able to use TestBed."><meta property="og:type" content="article"><meta property="og:url" content="https://mythical-angular.dev/posts/ngc-esbuild-jest/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-08T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-08T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="It looks that TestBed works with esbuild"><meta name=twitter:description content="In previous post &ldquo;esbuild against TestBed&rdquo; I said that TestBed is not working when we use esbuild to bundle tests. It seems like it&rsquo;s possible to work around the problems.
I said also that I&rsquo;m not sure what to think about the TestBed, is it worth using it or not. Every day, I&rsquo;m closer to getting my own opinion. But this is a subject for the next post.
Today we will focus on how to compile our tests with esbuild and still be able to use TestBed."><link rel=stylesheet href=https://mythical-angular.dev/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://mythical-angular.dev/css/custom.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script>
<script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://mythical-angular.dev/images/favicon.ico><script async src="https://www.googletagmanager.com/gtag/js?id=G-X7BCK4L1CF"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-X7BCK4L1CF",{anonymize_ip:!1})}</script></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><header id=header><a href=https://mythical-angular.dev><div id=logo style=background-image:url(https://mythical-angular.dev/logo.jpeg)></div><div id=title><h1>Mythical Angular</h1></div></a><div id=nav><ul><li class=icon><a href=# aria-label=Menu><i class="fas fa-bars fa-2x" aria-hidden=true></i></a></li><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li><li><a href=https://github.com/galczo5>GitHub</a></li></ul></div></header><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">It looks that TestBed works with esbuild</h1><div class=meta><div class=postdate><time datetime="2022-08-08 00:00:00 +0000 UTC" itemprop=datePublished>2022-08-08</time></div></div></header><div class=content itemprop=articleBody><p>In previous post <a href=https://mythical-angular.dev/posts/jest/>&ldquo;esbuild against TestBed&rdquo;</a> I said
that <code>TestBed</code> is not working when we use esbuild to bundle tests.
It seems like it&rsquo;s possible to work around the problems.</p><p>I said also that I&rsquo;m not sure what to think about the <code>TestBed</code>, is it worth using it or not.
Every day, I&rsquo;m closer to getting my own opinion.
But this is a subject for the next post.</p><p>Today we will focus on how to compile our tests with esbuild and still be able to use <code>TestBed</code>.</p><h2 id=repository>Repository</h2><p>As always, code you can find in my repository <a href=https://github.com/galczo5/ng-esbuild-tests>ng-esbuild-tests</a>.</p><p>I had to decompose and change the pipeline.
This time, esbuild is not used as a Jest transformer, but the compilation is executed before running the tests.
In this case, Jest doesn&rsquo;t need to do any transformation.
I had to do this because it was impossible to use esbuild plugins and provide a sync transformation for Jest.
For now, esbuild is supporting plugins only in the async build.</p><p>The only problem that I decided not to resolve now, is that there is no caching available.</p><p>In addition to the code, I&rsquo;ve created a repository with example unit tests using the <code>TestBed</code>. Here it is: <a href=https://github.com/galczo5/ng-esbuild-unit-tests>ng-esbuild-unit-tests</a>.</p><h2 id=test-results>Test results</h2><p>Today I will put the results of the tests before the code.
There is only one initial condition.
Because I don&rsquo;t have a caching mechanism in my code, I decided to disable cache in Jest with ts-jest.
Thanks to that, tests are comparable.</p><p>I have only 16 tests, all of them are using <code>TestBed</code> to create a component.</p><table><thead><tr><th>No.</th><th>ts-jest</th><th>esbuild</th><th>no compilation (working on result from esbuild)</th></tr></thead><tbody><tr><td>1</td><td>15.86s</td><td>13.90s</td><td>10.45s</td></tr><tr><td>2</td><td>16.07s</td><td>11.09s</td><td>10.48s</td></tr><tr><td>3</td><td>15.98s</td><td>11.79s</td><td>13.57s</td></tr></tbody></table><p>As you can see, results are interesting.
It&rsquo;s obvious that the compilation is not the most time-consuming part of the tests.
The problem is that, even if I skip the compilation part,
and use the results of the previous compilation, the tests are slow.</p><p>You may say, that 10s or 12s is not that long.
Let&rsquo;s do the math.
I was able to run 16 tests in about 12s.
In this case, one test took me 0.75s.</p><p>So, for an app that contains 300 components,
300 injectables and 100 directives if you want to have a test for every single object, you will spend about 525s.
<strong>It&rsquo;s almost 9 minutes!</strong>.
And having 700 tests, it is not that unusual.</p><p>We all heard about testing pyramid.
In theory, we should be able to have a huge number of unit tests, because they are fast.</p><h2 id=the-code>The code</h2><p>After the previous section,
you know that when you use <code>TestBed</code> there is not a lot of the difference between the ts-jest and esbuild.
Anyway, I want to show you how I implemented it, despite there is no sense of using it.</p><p>Let&rsquo;s start with the CLI.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>import</span> { program } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;commander&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> { runCLI } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;jest&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> { getPaths } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;./getPaths&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> { compile } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;./compile&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>program
</span></span><span style=display:flex><span>	.name(<span style=color:#f1fa8c>&#39;ng-esbuild-tests&#39;</span>)
</span></span><span style=display:flex><span>	.description(<span style=color:#f1fa8c>&#39;Run Angular tests faster thanks to Jest and esbuild&#39;</span>)
</span></span><span style=display:flex><span>	.option(<span style=color:#f1fa8c>&#39;--dir [dir]&#39;</span>, <span style=color:#f1fa8c>&#39;directory to scan, default: current directory&#39;</span>)
</span></span><span style=display:flex><span>	.option(<span style=color:#f1fa8c>&#39;--pattern [pattern]&#39;</span>, <span style=color:#f1fa8c>&#39;file pattern, default: ./**/*spec.ts&#39;</span>)
</span></span><span style=display:flex><span>	.option(<span style=color:#f1fa8c>&#39;--outDir [outDir]&#39;</span>, <span style=color:#f1fa8c>&#39;output directory, default: ./dist/ng-esbuild-tests/&#39;</span>)
</span></span><span style=display:flex><span>	.option(<span style=color:#f1fa8c>&#39;--skipCompile&#39;</span>, <span style=color:#f1fa8c>&#39;skip compilation part, only for tests!&#39;</span>)
</span></span><span style=display:flex><span>	.parse(process.argv);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> cli() {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> opts <span style=color:#ff79c6>=</span> program.opts();
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> dir <span style=color:#ff79c6>=</span> opts.dir <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;./&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> pattern <span style=color:#ff79c6>=</span> opts.pattern <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;**/*spec.ts&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> outDir <span style=color:#ff79c6>=</span> opts.outDir <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;./dist/ng-esbuild-tests/&#39;</span>;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> skipCompile <span style=color:#ff79c6>=</span> opts.skipCompile <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> paths <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> getPaths(dir, pattern);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>skipCompile) {
</span></span><span style=display:flex><span>		console.log(<span style=color:#f1fa8c>&#39;Files to compile with esbuild:&#39;</span>);
</span></span><span style=display:flex><span>		<span style=color:#6272a4>// eslint-disable-next-line no-restricted-syntax
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>		<span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>const</span> path <span style=color:#ff79c6>of</span> paths) {
</span></span><span style=display:flex><span>			console.log(<span style=color:#f1fa8c>`  </span><span style=color:#f1fa8c>${</span>path<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>await</span> compile(outDir, paths);
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>		console.warn(<span style=color:#f1fa8c>&#39;Compilation skipped!&#39;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> args <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>		roots<span style=color:#ff79c6>:</span> [<span style=color:#f1fa8c>&#39;./&#39;</span>],
</span></span><span style=display:flex><span>		testRegex<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;\\.spec\\.js$&#39;</span>,
</span></span><span style=display:flex><span>		testEnvironment<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;jsdom&#39;</span>
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>await</span> runCLI(args <span style=color:#ff79c6>as</span> <span style=color:#8be9fd>any</span>, [outDir]);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>To make my life easier, I create a simple CLI using <code>commander</code>.
It shows very well the process.</p><p>First of all, I get the CLI arguments and replace with the defaults if necessary.
To run tests I had to get the paths to the test files, it&rsquo;s implemented in <code>getPaths</code> function.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>import</span> { glob } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;glob&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> { join } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;path&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> getPaths(dir, patten) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>new</span> Promise&lt;<span style=color:#ff79c6>Array</span>&lt;<span style=color:#50fa7b>string</span>&gt;<span style=color:#ff79c6>&gt;</span>((resolve, reject) <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>		glob(join(dir, patten), (err, files) <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>if</span> (err) {
</span></span><span style=display:flex><span>				reject(err);
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			resolve(files);
</span></span><span style=display:flex><span>		});
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>After that, I&rsquo;m using the esbuild to compile the test files.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>import</span> { build } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;esbuild&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> { componentMetadataPlugin } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;./componentMetadataPlugin&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> { jestPresetAngularPlugin } <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;./jestPresetAngularPlugin&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> compile(outDir: <span style=color:#8be9fd>string</span>, paths: <span style=color:#8be9fd>Array</span>&lt;<span style=color:#ff79c6>string</span>&gt;) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> start <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Date</span>().getTime();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> build({
</span></span><span style=display:flex><span>		outdir: <span style=color:#8be9fd>outDir</span>,
</span></span><span style=display:flex><span>		entryPoints: <span style=color:#8be9fd>paths</span>,
</span></span><span style=display:flex><span>		bundle: <span style=color:#8be9fd>true</span>,
</span></span><span style=display:flex><span>		platform<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;node&#39;</span>,
</span></span><span style=display:flex><span>		minify: <span style=color:#8be9fd>false</span>,
</span></span><span style=display:flex><span>		format<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;iife&#39;</span>,
</span></span><span style=display:flex><span>		plugins<span style=color:#ff79c6>:</span> [
</span></span><span style=display:flex><span>			componentMetadataPlugin(),
</span></span><span style=display:flex><span>			jestPresetAngularPlugin()
</span></span><span style=display:flex><span>		],
</span></span><span style=display:flex><span>		loader<span style=color:#ff79c6>:</span> {
</span></span><span style=display:flex><span>			<span style=color:#f1fa8c>&#39;.html&#39;</span><span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;text&#39;</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> end <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>new</span> <span style=color:#8be9fd;font-style:italic>Date</span>().getTime();
</span></span><span style=display:flex><span>	console.log(<span style=color:#f1fa8c>`</span>\<span style=color:#f1fa8c>nCompilation end in </span><span style=color:#f1fa8c>${</span>end <span style=color:#ff79c6>-</span> start<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>ms!</span>\<span style=color:#f1fa8c>n`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Here I had to implement two plugins for esbuild.
Fortunately for me, I could use the plugins created in repository <a href=https://github.com/cherryApp/ngc-esbuild>cherryApp/ngc-esbuild</a>.
I really recommend investigating what the owned did there.
Really inspiring stuff.</p><p>So, the first, <code>jestPresetAngularPlugin</code> is pretty simple.
It&rsquo;s adding the necessary import as the first of the spec file.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>import</span> <span style=color:#ff79c6>*</span> <span style=color:#ff79c6>as</span> fs <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;fs&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> {
</span></span><span style=display:flex><span>	Loader, OnLoadResult, Plugin, PluginBuild
</span></span><span style=display:flex><span>} <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;esbuild&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> tsLoader: <span style=color:#8be9fd>Loader</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ts&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>function</span> processSpecFile(source: <span style=color:#8be9fd>string</span>)<span style=color:#ff79c6>:</span> OnLoadResult {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>source.includes(<span style=color:#f1fa8c>&#39;import \&#39;jest-preset-angular/setup-jest\&#39;&#39;</span>)) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>const</span> result <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>`import &#39;jest-preset-angular/setup-jest&#39;;</span>\<span style=color:#f1fa8c>n</span><span style=color:#f1fa8c>${</span>source<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>;
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>return</span> { contents: <span style=color:#8be9fd>result</span>, loader<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;ts&#39;</span> };
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> { contents: <span style=color:#8be9fd>source</span>, loader: <span style=color:#8be9fd>tsLoader</span> };
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>catch</span> (e) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> { errors<span style=color:#ff79c6>:</span> [e] };
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#8be9fd;font-style:italic>function</span> jestPresetAngularPlugin()<span style=color:#ff79c6>:</span> Plugin {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> {
</span></span><span style=display:flex><span>		name<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;jestPresetAngularPlugin&#39;</span>,
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>async</span> setup(build: <span style=color:#8be9fd>PluginBuild</span>) {
</span></span><span style=display:flex><span>			build.onLoad({ filter<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>/.*\.(spec)\.ts$/</span> }, <span style=color:#ff79c6>async</span> (args) <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>const</span> source <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> fs.promises.readFile(args.path, <span style=color:#f1fa8c>&#39;utf8&#39;</span>);
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> processSpecFile(source);
</span></span><span style=display:flex><span>			});
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>import 'jest-preset-angular/setup-jest';</code> is very important. It provides all the things required by the Angular. Stuff like <code>zone.js</code> etc.</p><p>The second plugin is more complicated.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff79c6>import</span> <span style=color:#ff79c6>*</span> <span style=color:#ff79c6>as</span> fs <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;fs&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>import</span> {
</span></span><span style=display:flex><span>	Loader, OnLoadResult, Plugin, PluginBuild
</span></span><span style=display:flex><span>} <span style=color:#ff79c6>from</span> <span style=color:#f1fa8c>&#39;esbuild&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> tsLoader: <span style=color:#8be9fd>Loader</span> <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>&#39;ts&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> correctNumberOfParts <span style=color:#ff79c6>=</span> <span style=color:#bd93f9>2</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> styleUrlsRegExp <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>/^ *styleUrls *: *\[[&#39;&#34;]([^&#39;&#34;\]]*)[&#39;&#34;]],*/gm</span>;
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> templateUrlRegExp <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>/^ *templateUrl *: *[&#39;&#34;]*([^&#39;&#34;]*)[&#39;&#34;]/gm</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>function</span> getValueByPattern(regex: <span style=color:#8be9fd>RegExp</span>, str: <span style=color:#8be9fd>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> results: <span style=color:#8be9fd>Array</span>&lt;<span style=color:#ff79c6>string</span>&gt; <span style=color:#ff79c6>=</span> [];
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>let</span> execArray <span style=color:#ff79c6>=</span> regex.exec(str);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>while</span> (execArray <span style=color:#ff79c6>!==</span> <span style=color:#ff79c6>null</span>) {
</span></span><span style=display:flex><span>		results.push(execArray[<span style=color:#bd93f9>1</span>]);
</span></span><span style=display:flex><span>		execArray <span style=color:#ff79c6>=</span> regex.exec(str);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> results.pop();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> removeStyles(contents: <span style=color:#8be9fd>string</span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> contents.replace(styleUrlsRegExp, <span style=color:#f1fa8c>&#39;styles: [],&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8be9fd;font-style:italic>function</span> processConstructor(contents) {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#f1fa8c>/constructor *\(([^)]*)/gm</span>.test(contents)) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> contents;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#8be9fd;font-style:italic>let</span> result <span style=color:#ff79c6>=</span> contents;
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>const</span> matches <span style=color:#ff79c6>=</span> result.matchAll(<span style=color:#f1fa8c>/constructor *\(([^)]*)/gm</span>);
</span></span><span style=display:flex><span>	<span style=color:#6272a4>// eslint-disable-next-line no-restricted-syntax
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#ff79c6>for</span> (<span style=color:#ff79c6>const</span> match <span style=color:#ff79c6>of</span> matches) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span>match[<span style=color:#bd93f9>1</span>] <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#f1fa8c>/:/gm</span>.test(match[<span style=color:#bd93f9>1</span>])) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>continue</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>const</span> flat <span style=color:#ff79c6>=</span> match[<span style=color:#bd93f9>1</span>].replace(<span style=color:#f1fa8c>/[\n\r]/gm</span>, <span style=color:#f1fa8c>&#39;&#39;</span>);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>const</span> flatArray <span style=color:#ff79c6>=</span> flat.split(<span style=color:#f1fa8c>&#39;,&#39;</span>)
</span></span><span style=display:flex><span>			.map((inject) <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>const</span> parts <span style=color:#ff79c6>=</span> inject.split(<span style=color:#f1fa8c>&#39;:&#39;</span>);
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>const</span> partsCorrect <span style=color:#ff79c6>=</span> parts.length <span style=color:#ff79c6>===</span> correctNumberOfParts;
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>const</span> providerDoesNotContainInject <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>!</span><span style=color:#f1fa8c>/@Inject/</span>.test(inject);
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>const</span> shouldAddInject <span style=color:#ff79c6>=</span> partsCorrect <span style=color:#ff79c6>&amp;&amp;</span> providerDoesNotContainInject;
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> shouldAddInject <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>`@Inject(</span><span style=color:#f1fa8c>${</span>parts[<span style=color:#bd93f9>1</span>]<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>) </span><span style=color:#f1fa8c>${</span>inject<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span> <span style=color:#ff79c6>:</span> inject;
</span></span><span style=display:flex><span>			});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>const</span> constructorRegExp <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>/constructor *\([^)]*\)/gm</span>;
</span></span><span style=display:flex><span>		result <span style=color:#ff79c6>=</span> result.replace(constructorRegExp, <span style=color:#f1fa8c>`constructor(</span><span style=color:#f1fa8c>${</span>flatArray.join(<span style=color:#f1fa8c>&#39;,&#39;</span>)<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>)`</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>if</span> (<span style=color:#ff79c6>!</span><span style=color:#f1fa8c>/Inject[ ,}\n\r].*&#39;@angular\/core.*;/</span>.test(result)) {
</span></span><span style=display:flex><span>		result <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>`import { Inject } from &#39;@angular/core&#39;;</span>\<span style=color:#f1fa8c>n</span><span style=color:#f1fa8c>${</span>result<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> result;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>async</span> <span style=color:#8be9fd;font-style:italic>function</span> processComponentMetadata(source: <span style=color:#8be9fd>string</span>)<span style=color:#ff79c6>:</span> Promise&lt;<span style=color:#ff79c6>OnLoadResult</span>&gt; {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>try</span> {
</span></span><span style=display:flex><span>		<span style=color:#8be9fd;font-style:italic>let</span> result <span style=color:#ff79c6>=</span> source;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>const</span> hasTemplateUrl <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>/^ *templateUrl *: *[&#39;&#34;]*([^&#39;&#34;]*)/gm</span>.test(result);
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>if</span> (hasTemplateUrl) {
</span></span><span style=display:flex><span>			<span style=color:#ff79c6>const</span> templateUrl <span style=color:#ff79c6>=</span> getValueByPattern(<span style=color:#f1fa8c>/^ *templateUrl *: *[&#39;&#34;]*([^&#39;&#34;]*)/gm</span>, source);
</span></span><span style=display:flex><span>			result <span style=color:#ff79c6>=</span> <span style=color:#f1fa8c>`import templateSource from &#39;</span><span style=color:#f1fa8c>${</span>templateUrl<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>&#39;;</span>\<span style=color:#f1fa8c>n</span><span style=color:#f1fa8c>${</span>result<span style=color:#f1fa8c>}</span><span style=color:#f1fa8c>`</span>
</span></span><span style=display:flex><span>				.replace(templateUrlRegExp, <span style=color:#f1fa8c>&#39;template: templateSource || &#34;&#34;&#39;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		result <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> removeStyles(result <span style=color:#ff79c6>||</span> <span style=color:#f1fa8c>&#39;&#39;</span>);
</span></span><span style=display:flex><span>		result <span style=color:#ff79c6>=</span> processConstructor(result);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> { contents: <span style=color:#8be9fd>result</span>, loader: <span style=color:#8be9fd>tsLoader</span> };
</span></span><span style=display:flex><span>	} <span style=color:#ff79c6>catch</span> (e) {
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>return</span> { errors<span style=color:#ff79c6>:</span> [e] };
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#8be9fd;font-style:italic>function</span> componentMetadataPlugin()<span style=color:#ff79c6>:</span> Plugin {
</span></span><span style=display:flex><span>	<span style=color:#ff79c6>return</span> {
</span></span><span style=display:flex><span>		name<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;componentMetadataPlugin&#39;</span>,
</span></span><span style=display:flex><span>		<span style=color:#ff79c6>async</span> setup(build: <span style=color:#8be9fd>PluginBuild</span>) {
</span></span><span style=display:flex><span>			build.onLoad({ filter<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>/src.*\.(component|pipe|service|directive|guard|module)\.ts$/</span> }, <span style=color:#ff79c6>async</span> (args) <span style=color:#ff79c6>=&gt;</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>const</span> source <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>await</span> fs.promises.readFile(args.path, <span style=color:#f1fa8c>&#39;utf8&#39;</span>);
</span></span><span style=display:flex><span>				<span style=color:#ff79c6>return</span> <span style=color:#ff79c6>await</span> processComponentMetadata(source);
</span></span><span style=display:flex><span>			});
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>It does three things:</p><ul><li>removes the <code>styleUrls</code> property of the <code>@Component</code> decorator. We are not rendering the component in the browser, so there is no need to keep it.</li><li>adds <code>@Inject</code> decorator to all arguments in the components, services, pipes, directives, guards and modules. Without this action, Jest is not able to inject anything to your objects.</li><li>replaces <code>templateUrl</code> with <code>template</code> and import to the files. The bundler loads the template in this case as a text, and then assigns it to the component.</li></ul><p>After the compilation, in the <code>dist</code> directory I have tests compile, and the only last thing to do is to start Jest.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>    <span style=color:#6272a4>// ...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>	<span style=color:#ff79c6>const</span> args <span style=color:#ff79c6>=</span> {
</span></span><span style=display:flex><span>        roots<span style=color:#ff79c6>:</span> [<span style=color:#f1fa8c>&#39;./&#39;</span>],
</span></span><span style=display:flex><span>        testRegex<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;\\.spec\\.js$&#39;</span>,
</span></span><span style=display:flex><span>        testEnvironment<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;jsdom&#39;</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>await</span> runCLI(args <span style=color:#ff79c6>as</span> <span style=color:#8be9fd>any</span>, [outDir]);
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ...
</span></span></span></code></pre></td></tr></table></div></div><h2 id=summary>Summary</h2><p>Basically, this is it.</p><p>As I mentioned, probably, there is no sense to fight with <code>TestBed</code>.
It&rsquo;s slow.</p><p><img src=/images/jest-preset-angular.png alt=jest-preset-angular></p><p>PS. <code>jest-preset-angular</code> has support for the esbuild.
It compiles all of the <code>.mjs</code> files with esbuild and additional pointed files.</p><p>PPS. I check the difference in time between TestBed-based tests and regular tests.
You can check it in the next post or just follow the link: <a href=https://mythical-angular.dev/posts/testbed-time/>Short: I had some time, so I checked how much time-consuming is TesBed</a>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#6272a4>/**
</span></span></span><span style=display:flex><span><span style=color:#6272a4> * Some NPM packages like `tslib` is distributed in such a way that `esbuild` cannot process it, so we fall back to use TypeScript API
</span></span></span><span style=display:flex><span><span style=color:#6272a4> */</span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>const</span> defaultProcessWithEsbuildPatterns <span style=color:#ff79c6>=</span> [<span style=color:#f1fa8c>&#39;**/*.mjs&#39;</span>];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#ff79c6>class</span> NgJestConfig <span style=color:#ff79c6>extends</span> ConfigSet {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>readonly</span> processWithEsbuild: <span style=color:#8be9fd>ReturnType</span>&lt;<span style=color:#ff79c6>typeof</span> <span style=color:#50fa7b>globsToMatcher</span>&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>constructor</span>(jestConfig: <span style=color:#8be9fd>ProjectConfigTsJest</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>undefined</span>, parentLogger?: <span style=color:#8be9fd>Logger</span> <span style=color:#ff79c6>|</span> <span style=color:#ff79c6>undefined</span>) {
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>super</span>(jestConfig, parentLogger);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>const</span> jestGlobalsConfig <span style=color:#ff79c6>=</span> jestConfig<span style=color:#ff79c6>?</span>.globals<span style=color:#ff79c6>?</span>.ngJest <span style=color:#ff79c6>??</span> <span style=color:#8be9fd;font-style:italic>Object</span>.create(<span style=color:#ff79c6>null</span>);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>this</span>.processWithEsbuild <span style=color:#ff79c6>=</span> globsToMatcher([
</span></span><span style=display:flex><span>            ...(jestGlobalsConfig.processWithEsbuild <span style=color:#ff79c6>??</span> []),
</span></span><span style=display:flex><span>            ...defaultProcessWithEsbuildPatterns,
</span></span><span style=display:flex><span>        ]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>export</span> <span style=color:#ff79c6>class</span> NgJestTransformer <span style=color:#ff79c6>extends</span> TsJestTransformer {
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#6272a4>// ...
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>    
</span></span><span style=display:flex><span>    process(fileContent: <span style=color:#8be9fd>string</span>, filePath: <span style=color:#8be9fd>string</span>, transformOptions: <span style=color:#8be9fd>TransformOptionsTsJest</span>)<span style=color:#ff79c6>:</span> TransformedSource {
</span></span><span style=display:flex><span>        <span style=color:#6272a4>// @ts-expect-error we are accessing the private cache to avoid creating new objects all the time
</span></span></span><span style=display:flex><span><span style=color:#6272a4></span>        <span style=color:#ff79c6>const</span> configSet <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>super</span>._configsFor(transformOptions);
</span></span><span style=display:flex><span>        <span style=color:#ff79c6>if</span> (configSet.processWithEsbuild(filePath)) {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>this</span>.#ngJestLogger.debug({ filePath }, <span style=color:#f1fa8c>&#39;process with esbuild&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>const</span> compilerOpts <span style=color:#ff79c6>=</span> configSet.parsedTsConfig.options;
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>const</span> { code, map } <span style=color:#ff79c6>=</span> <span style=color:#ff79c6>this</span>.#esbuildImpl.transformSync(fileContent, {
</span></span><span style=display:flex><span>                loader<span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;js&#39;</span>,
</span></span><span style=display:flex><span>                format: <span style=color:#8be9fd>transformOptions.supportsStaticESM</span> <span style=color:#ff79c6>&amp;&amp;</span> configSet.useESM <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#39;esm&#39;</span> <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;cjs&#39;</span>,
</span></span><span style=display:flex><span>                target: <span style=color:#8be9fd>compilerOpts.target</span> <span style=color:#ff79c6>===</span> configSet.compilerModule.ScriptTarget.ES2015 <span style=color:#ff79c6>?</span> <span style=color:#f1fa8c>&#39;es2015&#39;</span> <span style=color:#ff79c6>:</span> <span style=color:#f1fa8c>&#39;es2016&#39;</span>,
</span></span><span style=display:flex><span>                sourcemap: <span style=color:#8be9fd>compilerOpts.sourceMap</span>,
</span></span><span style=display:flex><span>                sourcefile: <span style=color:#8be9fd>filePath</span>,
</span></span><span style=display:flex><span>                sourcesContent: <span style=color:#8be9fd>true</span>,
</span></span><span style=display:flex><span>                sourceRoot: <span style=color:#8be9fd>compilerOpts.sourceRoot</span>,
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> {
</span></span><span style=display:flex><span>                code,
</span></span><span style=display:flex><span>                map,
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        } <span style=color:#ff79c6>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#ff79c6>return</span> <span style=color:#ff79c6>super</span>.process(fileContent, filePath, transformOptions);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li><li><a href=https://github.com/galczo5>GitHub</a></li></ul></div><div id=toc-footer style=display:none><nav id=TableOfContents><ul><li><a href=#repository>Repository</a></li><li><a href=#test-results>Test results</a></li><li><a href=#the-code>The code</a></li><li><a href=#summary>Summary</a></li></ul></nav></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f&text=It%20looks%20that%20TestBed%20works%20with%20esbuild" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f&title=It%20looks%20that%20TestBed%20works%20with%20esbuild" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f&is_video=false&description=It%20looks%20that%20TestBed%20works%20with%20esbuild" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=It%20looks%20that%20TestBed%20works%20with%20esbuild&body=Check out this article: https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f&title=It%20looks%20that%20TestBed%20works%20with%20esbuild" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f&title=It%20looks%20that%20TestBed%20works%20with%20esbuild" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f&name=It%20looks%20that%20TestBed%20works%20with%20esbuild&description=In%20previous%20post%20%26ldquo%3besbuild%20against%20TestBed%26rdquo%3b%20I%20said%20that%20TestBed%20is%20not%20working%20when%20we%20use%20esbuild%20to%20bundle%20tests.%20It%20seems%20like%20it%26rsquo%3bs%20possible%20to%20work%20around%20the%20problems.%0aI%20said%20also%20that%20I%26rsquo%3bm%20not%20sure%20what%20to%20think%20about%20the%20TestBed%2c%20is%20it%20worth%20using%20it%20or%20not.%20Every%20day%2c%20I%26rsquo%3bm%20closer%20to%20getting%20my%20own%20opinion.%20But%20this%20is%20a%20subject%20for%20the%20next%20post.%0aToday%20we%20will%20focus%20on%20how%20to%20compile%20our%20tests%20with%20esbuild%20and%20still%20be%20able%20to%20use%20TestBed." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fmythical-angular.dev%2fposts%2fngc-esbuild-jest%2f&t=It%20looks%20that%20TestBed%20works%20with%20esbuild" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=toc-toggle class=icon href=# onclick='return $("#toc-footer").toggle(),!1' aria-label=TOC><i class="fas fa-list fa-lg" aria-hidden=true></i> TOC</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; 2023 Kamil Gaek</div><div class=footer-right><nav><ul><li><a href=/>Home</a></li><li><a href=/posts>All posts</a></li><li><a href=/tags>Tags</a></li><li><a href=https://github.com/galczo5>GitHub</a></li></ul></nav></div></footer></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
<script src=/js/code-copy.js></script></html>